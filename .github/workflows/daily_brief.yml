name: Daily Bitcoin Mining News Brief

on:
  schedule:
    # Run daily at 7:00 AM UTC (2:00 AM EST, 11:00 PM PST previous day)
    - cron: '0 7 * * *'
  workflow_dispatch:
    inputs:
      output_mode:
        description: 'Output mode for the brief'
        required: false
        default: 'console'
        type: choice
        options:
          - console
          - file
          - issue
      days_back:
        description: 'Number of days to look back for articles'
        required: false
        default: '1'
        type: string

env:
  # Twitter API (not needed for daily brief, but may be used for validation)
  TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
  TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
  TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
  TWITTER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
  
  # News API
  EVENTREGISTRY_API_KEY: ${{ secrets.EVENTREGISTRY_API_KEY }}
  
  # Gemini AI
  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
  
  # Google Agentspace API for Deep Research
  AGENTS_PROJECT_ID: ${{ secrets.AGENTS_PROJECT_ID }}
  AGENTS_APP_ID: ${{ secrets.AGENTS_APP_ID }}
  AGENTS_DATA_STORE_ID: ${{ secrets.AGENTS_DATA_STORE_ID }}
  
  # Google Cloud credentials for Agentspace API
  GOOGLE_APPLICATION_CREDENTIALS_JSON: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS_JSON }}

jobs:
  daily-brief:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 1
    
    - name: Setup Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: Setup Google Cloud Credentials
      if: env.GOOGLE_APPLICATION_CREDENTIALS_JSON != ''
      run: |
        echo '${{ secrets.GOOGLE_APPLICATION_CREDENTIALS_JSON }}' > /tmp/gcp-key.json
        echo "GOOGLE_APPLICATION_CREDENTIALS=/tmp/gcp-key.json" >> $GITHUB_ENV
      
    - name: Install Dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
        # Install additional dependencies for daily briefing
        pip install google-api-python-client>=2.0.0
        pip install aiohttp>=3.8.0
      timeout-minutes: 5
    
    - name: Verify API Keys Configuration
      run: |
        echo "🔍 Checking API key configuration..."
        python -c "
        import os
        keys = {
          'EVENTREGISTRY_API_KEY': bool(os.getenv('EVENTREGISTRY_API_KEY')),
          'GEMINI_API_KEY': bool(os.getenv('GEMINI_API_KEY')),
          'AGENTS_PROJECT_ID': bool(os.getenv('AGENTS_PROJECT_ID')),
          'AGENTS_APP_ID': bool(os.getenv('AGENTS_APP_ID')),
          'AGENTS_DATA_STORE_ID': bool(os.getenv('AGENTS_DATA_STORE_ID')),
          'GOOGLE_APPLICATION_CREDENTIALS': bool(os.getenv('GOOGLE_APPLICATION_CREDENTIALS'))
        }
        for key, present in keys.items():
          status = '✅' if present else '❌'
          print(f'{status} {key}: {\"Present\" if present else \"Missing\"}')
        
        missing = [k for k, v in keys.items() if not v]
        if missing:
          print(f'\\n⚠️  Missing keys: {missing}')
          print('Note: Daily briefing will use fallback modes for missing integrations')
        else:
          print('\\n🎉 All API keys configured!')
        "
    
    - name: Run Daily Brief Generation
      id: daily_brief
      run: |
        echo "🤖 Generating daily Bitcoin mining news brief..."
        
        # Set output mode and days back from inputs or defaults
        OUTPUT_MODE="${{ github.event.inputs.output_mode || 'console' }}"
        DAYS_BACK="${{ github.event.inputs.days_back || '1' }}"
        
        echo "📊 Configuration:"
        echo "  Output Mode: $OUTPUT_MODE"
        echo "  Days Back: $DAYS_BACK"
        echo ""
        
        # Run the daily briefing
        python daily_briefing.py --days-back "$DAYS_BACK" --output "$OUTPUT_MODE" --verbose
      timeout-minutes: 20
      continue-on-error: true
    
    - name: Upload Brief as Artifact
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: daily-brief-${{ github.run_number }}
        path: |
          daily_brief_*.md
          daily_brief_*.txt
          articles_log.json
        retention-days: 30
    
    - name: Create GitHub Issue with Brief
      if: github.event.inputs.output_mode == 'issue' && steps.daily_brief.outcome == 'success'
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          const path = require('path');
          
          // Find the generated brief file
          const files = fs.readdirSync('.');
          const briefFile = files.find(f => f.startsWith('daily_brief_') && f.endsWith('.md'));
          
          if (briefFile) {
            const briefContent = fs.readFileSync(briefFile, 'utf8');
            const today = new Date().toISOString().split('T')[0];
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `📊 Daily Bitcoin Mining News Brief - ${today}`,
              body: briefContent,
              labels: ['daily-brief', 'automated', 'bitcoin-mining']
            });
            
            console.log(`✅ Created GitHub issue with daily brief`);
          } else {
            console.log('❌ No brief file found to create issue');
          }
    
    - name: Commit Updated Logs
      if: always()
      run: |
        # Configure Git
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Check for changes in log files
        if git diff --exit-code articles_log.json >/dev/null 2>&1; then
          echo "📝 No changes to articles log"
        else
          echo "📝 Committing updated articles log..."
          git add articles_log.json
          git commit -m "📊 Update articles log from daily brief generation
          
          - Generated on: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          - Run ID: ${{ github.run_id }}
          - Days back: ${{ github.event.inputs.days_back || '1' }}"
          git push
        fi
      continue-on-error: true
    
    - name: Summary Report
      if: always()
      run: |
        echo "🏁 Daily Brief Generation Summary"
        echo "=================================="
        echo "Workflow: ${{ github.workflow }}"
        echo "Run ID: ${{ github.run_id }}"
        echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo "Status: ${{ steps.daily_brief.outcome }}"
        echo ""
        
        if [ -f "articles_log.json" ]; then
          echo "📊 Articles Log Status: ✅ Present"
          python -c "
          import json
          try:
            with open('articles_log.json', 'r') as f:
              data = json.load(f)
            print(f'  Total articles logged: {data.get(\"total_articles\", 0)}')
            daily = data.get('daily_articles', [])
            if daily:
              latest = daily[-1]
              print(f'  Latest date: {latest.get(\"date\", \"unknown\")}')
              print(f'  Articles today: {len(latest.get(\"articles\", []))}')
          except Exception as e:
            print(f'  Error reading log: {e}')
          "
        else
          echo "📊 Articles Log Status: ❌ Missing"
        fi
        
        echo ""
        if ls daily_brief_*.md >/dev/null 2>&1; then
          echo "📄 Brief Files Generated: ✅"
          for file in daily_brief_*.md; do
            size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null || echo "unknown")
            echo "  - $file (${size} bytes)"
          done
        else
          echo "📄 Brief Files Generated: ❌ None found"
        fi